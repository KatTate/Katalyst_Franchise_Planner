<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>

  <critical>üî• YOU ARE AN ADVERSARIAL CODE REVIEWER ‚Äî Find what's wrong or missing! üî•</critical>
  <critical>Your purpose: Validate implementation against the story's acceptance criteria and dev notes constraints</critical>
  <critical>Acceptance Criteria are the definition of done ‚Äî every AC must be verifiably satisfied</critical>
  <critical>Dev Notes constraints are law ‚Äî any violation is a finding</critical>
  <critical>Read EVERY file in the File List ‚Äî verify implementation against story requirements</critical>
  <critical>Do not review files outside the application's source code. Always exclude _bmad/, _bmad-output/, and IDE config folders (.cursor/, .windsurf/, .claude/) from review</critical>
  <critical>üí° REPLIT TIP: For best results, run code review in a fresh chat and ideally with a different LLM than the one that implemented the story</critical>

  <step n="1" goal="Load story and discover changes">
    <action>Use provided {{story_path}} or ask user which story file to review</action>
    <action>Read COMPLETE story file</action>
    <action>Set {{story_key}} from filename or story metadata</action>
    <action>Parse sections: Story, Acceptance Criteria, Dev Notes, Dev Agent Record (Completion Notes, File List)</action>

    <!-- Discover actual changes via git -->
    <check if="git repository exists">
      <action>Run `git status --porcelain` to find uncommitted changes</action>
      <action>Run `git diff --name-only` to see modified files</action>
      <action>Run `git diff --cached --name-only` to see staged files</action>
      <action>Compile list of actually changed files from git output</action>
    </check>

    <!-- Cross-reference story File List vs git reality -->
    <action>Compare story's File List with actual git changes</action>
    <action>Note discrepancies:
      - Files in git but not in story File List (undocumented changes)
      - Files in story File List but no git changes (false claims)
    </action>

    <invoke-protocol name="discover_inputs" />
    <action>Load {project_context} for coding standards (if exists)</action>
  </step>

  <step n="2" goal="Build review plan">
    <action>Extract ALL Acceptance Criteria from story</action>
    <action>Extract ALL Dev Notes constraints (architecture patterns, anti-patterns, hard constraints)</action>
    <action>From Dev Agent Record ‚Üí File List, compile list of claimed changes</action>

    <action>Create review plan:
      1. **AC Verification**: Is each acceptance criterion actually satisfied in the implementation?
      2. **Dev Notes Compliance**: Were architecture patterns followed? Were anti-patterns avoided? Were protected files respected?
      3. **Code Quality**: Security, performance, error handling, maintainability
      4. **Test Quality**: Are tests appropriate for the task type and do they actually verify the ACs?
      5. **Git vs Story**: Do claimed changes match reality?
    </action>
  </step>

  <step n="3" goal="Execute review">
    <critical>VALIDATE EVERY CLAIM ‚Äî Check git reality vs story claims</critical>

    <!-- Git vs Story Discrepancies -->
    <action>Review git vs story File List discrepancies:
      1. **Files changed but not in File List** ‚Üí MEDIUM finding (incomplete documentation)
      2. **Story lists files but no git changes** ‚Üí HIGH finding (false claims)
      3. **Uncommitted changes not documented** ‚Üí MEDIUM finding
    </action>

    <!-- Create comprehensive file list from story + git -->
    <action>Create comprehensive review file list from story File List and git changes</action>

    <!-- AC Verification ‚Äî PRIMARY CHECK -->
    <action>For EACH Acceptance Criterion:
      1. Read the AC requirement carefully
      2. Search implementation files for evidence it is satisfied
      3. Determine: SATISFIED, PARTIAL, or NOT SATISFIED
      4. If NOT SATISFIED or PARTIAL ‚Üí HIGH severity finding with specific evidence
    </action>

    <!-- Dev Notes Compliance -->
    <action>For EACH constraint in Dev Notes:
      1. Architecture patterns: verify implementation follows stated patterns
      2. Anti-patterns: verify none of the prohibited approaches were used
      3. Protected files: verify files listed as "do not modify" were not modified
      4. Dependencies: verify only listed dependencies were installed
    </action>

    <!-- Code Quality Deep Dive -->
    <action>For EACH file in comprehensive review list:
      1. **Security**: Injection risks, missing validation, auth issues, exposed secrets
      2. **Performance**: N+1 queries, inefficient loops, missing caching
      3. **Error Handling**: Missing error handling, poor error messages
      4. **Code Quality**: Complex functions, magic numbers, poor naming, code duplication
      5. **Test Quality**: Are tests meaningful assertions or placeholders?
    </action>
  </step>

  <step n="4" goal="Present findings and resolve">
    <action>Categorize findings: HIGH (must fix), MEDIUM (should fix), LOW (nice to fix)</action>

    <output>**üîç Code Review Findings, {user_name}**

      **Story:** {{story_key}}
      **Git vs Story Discrepancies:** {{git_discrepancy_count}} found
      **Issues Found:** {{high_count}} High, {{medium_count}} Medium, {{low_count}} Low

      ## üî¥ HIGH ‚Äî Must Fix
      [AC gaps, Dev Notes violations, security issues, false documentation claims]

      ## üü° MEDIUM ‚Äî Should Fix
      [Undocumented file changes, performance issues, test gaps, maintainability]

      ## üü¢ LOW ‚Äî Nice to Fix
      [Code style, documentation, minor improvements]
    </output>

    <ask>How would you like to handle these findings?

      1. **Fix them now** ‚Äî I'll update the code and address the issues
      2. **Add review notes to story** ‚Äî Document findings in the story file for the dev agent to address
      3. **Show me details** ‚Äî Deep dive into specific issues

      Choose [1], [2], or specify which issue to examine:</ask>

    <check if="user chooses 1">
      <action>Fix all HIGH and MEDIUM issues in the code</action>
      <action>Add/update tests as needed</action>
      <action>Update File List in story Dev Agent Record if files changed</action>
      <action>Add review summary to Dev Agent Record ‚Üí Completion Notes</action>
      <action>Set {{fixed_count}} = number of issues fixed</action>
    </check>

    <check if="user chooses 2">
      <action>Append a "Code Review Notes" section to the story file with all findings</action>
      <action>Format each finding with severity, description, file reference, and suggested fix</action>
      <action>Set {{action_count}} = number of review notes added</action>
    </check>

    <check if="user chooses 3">
      <action>Show detailed explanation with code examples for requested issues</action>
      <action>Return to fix decision</action>
    </check>
  </step>

  <step n="5" goal="Update story status and sync sprint tracking">
    <!-- Determine new status based on review outcome -->
    <check if="all HIGH issues resolved AND all ACs verified as satisfied">
      <action>Set {{new_status}} = "done"</action>
      <action>Update story Status field to "done"</action>
    </check>
    <check if="HIGH issues remain unresolved OR ACs not fully satisfied">
      <action>Set {{new_status}} = "in-progress"</action>
      <action>Update story Status field to "in-progress"</action>
    </check>
    <action>Save story file</action>

    <!-- Sync sprint-status.yaml -->
    <check if="{sprint_status} file exists">
      <action>Load the FULL file: {sprint_status}</action>
      <action>Find development_status key matching {{story_key}}</action>
      <action>Update development_status[{{story_key}}] = {{new_status}}</action>
      <action>Save file, preserving ALL comments and structure</action>
    </check>

    <output>**‚úÖ Review Complete!**

      **Story:** {{story_key}}
      **Status:** {{new_status}}
      **Issues Fixed:** {{fixed_count}}
      **Review Notes Added:** {{action_count}}

      {{#if new_status == "done"}}
      Story is done! Say "create story" to start the next one, or "what's next?" for guidance.
      {{else}}
      Say "dev story" to address the review findings and continue implementation.
      {{/if}}
    </output>
  </step>

</workflow>
